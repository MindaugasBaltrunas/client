import { ApiClientConfig } from '../../config/type';
import { ApiError } from '../../shared/errors/ApiError';
import { createApiRecipientRepository, RecipientRepository } from '../../infrastructure/repositories/ApiRecipientRepository';
import { createRecipientApiClient } from '../../infrastructure/api/clients/RecipientApiClient';
import { RecipientData } from '../../domains/recipient/recipient';
import { MutationConfig } from '../../config/mutationConfig'

const useRecipientMutations = (
    config: ApiClientConfig,
    defaultToastHandler?: {
        success?: (msg: string) => void;
        error?: (msg: string) => void;
    }
) => {
    const apiClient = createRecipientApiClient(config);
    const repository: RecipientRepository = createApiRecipientRepository(apiClient);

    const useCreateRecipient = (options?: MutationConfig<RecipientData, ApiError, RecipientData>) => {
        return repository.useCreateRecipient({
            onSuccess: (recipient, variables, context) => {
                if (options?.showSuccessToast ?? true) {
                    const message = options?.successMessage ??
                        `Recipient ${recipient.name || recipient.id} created successfully!`;
                    const toastHandler = options?.toastHandler?.success ?? defaultToastHandler?.success;
                    toastHandler?.(message);
                }
                options?.onSuccess?.(recipient, variables, context);
            },
            onError: (error: Error, variables, context) => {
                const apiError = error as ApiError;
                if (options?.showErrorToast ?? true) {
                    const message = options?.errorMessage ?? `Failed to create recipient: ${apiError.message ?? 'Unknown error'}`;
                    const toastHandler = options?.toastHandler?.error ?? defaultToastHandler?.error;
                    toastHandler?.(message);
                }

                options?.onError?.(apiError, variables, context);
            },
            ...options,
        });
    };

    return {
        useCreateRecipient
    };
};

export default useRecipientMutations;